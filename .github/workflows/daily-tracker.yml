name: Open-VSX Download Tracker

on:
  # æ¯å¤©å‡Œæ™¨5ç‚¹ï¼ˆUTC+0æ—¶é—´21:00ï¼‰è¿è¡Œ
  schedule:
    - cron: '0 21 * * *'  # UTC 9:00 PM = åŒ—äº¬æ—¶é—´ 5:00 AM
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write  # å…è®¸æ¨é€ä»£ç 

jobs:
  track-downloads:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ä¸‹è½½å†å²æ•°æ®
        continue-on-error: true
        run: |
          # ä»ä¸Šä¸€æ¬¡è¿è¡Œä¸­æ¢å¤å†å²æ•°æ®
          if [ -f download_history.json ]; then
            echo "æ‰¾åˆ°å†å²æ•°æ®æ–‡ä»¶"
          else
            echo "æœªæ‰¾åˆ°å†å²æ•°æ®æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶"
          fi
      
      - name: éªŒè¯é…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          echo "=== é‚®ä»¶é…ç½®éªŒè¯ ==="
          echo "SENDER_EMAIL: *****${SENDER_EMAIL:5}"
          echo "RECEIVER_EMAIL: *****${RECEIVER_EMAIL:5}"
          echo "===================="

      - name: è¿è¡Œä¸‹è½½é‡è¿½è¸ªå™¨
        env:
          EXTENSION_NAMESPACE: ${{ secrets.EXTENSION_NAMESPACE }}
          EXTENSION_NAME: ${{ secrets.EXTENSION_NAME }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          python tracker.py
      
      - name: æäº¤å†å²æ•°æ®
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add download_history.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š Update download history - $(TZ=Asia/Shanghai date +'%Y-%m-%d')"
          git push

